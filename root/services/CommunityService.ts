import IMServiceManager from "@/utils/IMServiceManager";
import { log, toast } from "@/utils/system";
import { Alert } from "react-native";
import { IMService, UserService } from ".";
import { CommunityRequest, IDBITRequest } from "../request";
import { JoinGroupParams } from "./open_im_sdk/types";
import Constants, { CacheKeys, ReduxToken } from "@/constants/index";
import { CreateCommunityApiType, CreateCommunityChannelApiType, GetUserJoinedGroupListParams, ModifyCommunityParam } from "./types";
import { messageTypes, tipsTypes } from "./open_im_sdk/constants/messageContentType";
import { t } from "i18next";
import { gd } from "@/utils/pglobal";
import { ethers } from "ethers";
import {pinJsonToIPFS } from "@/utils/uploadFile";
/**
 * 获取社区列表
 * @param ensDomain
 */
export const getCommunityList = async (data: any) => {
  const { reduxParams, imUserInfo } = data.params
  const grouplist = await IMServiceManager.getInstance().getJoinedGroupList();
  const arr = JSON.parse(grouplist?.data)
  let newRes = [];
  for (let index = 0; index < arr.length; index++) {
    let newDic = {};
    const element = arr[index];
    const conversationData = await getUnreadCount(element?.groupID);
    newDic = element;
    newDic.faceURL = handleFixIpfs(element.faceURL);
    newDic.isJoinEd = true;
    newDic.conversationData = conversationData;
    let latestMsg = JSON.parse(conversationData.latestMsg);
    if (latestMsg.content.indexOf('aiHtml') != -1) latestMsg.content = ''
    if (latestMsg.contentType == tipsTypes.MEMBERENTER) {
      latestMsg.content = latestMsg.sendID + t('community.join') + t('community.community2')
      if (latestMsg.sendID == imUserInfo?.userID) latestMsg.content = t('community.welecome') + ' ' + latestMsg.senderNickname;
    }
    else if (latestMsg.contentType == tipsTypes.MEMBERQUIT) {
      latestMsg.content = latestMsg.sendID + t('community.withdraw2') + t('community.community2')
    }
    else if (latestMsg.contentType == tipsTypes.GROUPCHANNELINFOADD) {
      const info = JSON.parse(JSON.parse(latestMsg?.content)?.jsonDetail).groupChannelInfoTip;
      latestMsg.content = t('community.publish2') + info?.channelName
    }
    else if (latestMsg.contentType == tipsTypes.GROUPCREATED) {
      latestMsg.content = t('community.welcome') + ' ' + conversationData.showName
    }
    else if (latestMsg.contentType == messageTypes.TEXTMESSAGE || latestMsg.contentType == messageTypes.PICTUREMESSAGE) {
      if (latestMsg.channelID == '1' && latestMsg.content != '') {
        latestMsg.content = t('community.publish') + ' ' + latestMsg.content
      }
    }
    else if (latestMsg.contentType == tipsTypes.GROUPINFOUPDATED) {
      latestMsg.content = t('community.update')
    }

    // if (latestMsg.contentType == messageTypes.TEXTMESSAGE || latestMsg.contentType == messageTypes.PICTUREMESSAGE) {
    // }
    // else {
    //   Alert.alert(JSON.stringify(latestMsg.contentType))
    //   // if(latestMsg.sendID==userID)
    //   latestMsg.content = t('community.welcome') + ' ' + conversationData.showName
    // }
    newDic.conversationData.latestMsg = latestMsg;
    newRes.push(newDic)
  }
  log(newRes, 'newRes')
  const { sendReduxAction } = reduxParams;
  sendReduxAction(ReduxToken.SET_COMMUNITIES, { communities: newRes });
  return { list: newRes }
};
/**
 * 在我加入的社区，搜索
 */
export const searchInJoinGroup = async (data: any) => {
  const { text, communities } = data.params
  let result = []
  for (let index = 0; index < communities.length; index++) {
    const el = communities[index];
    if (el.groupName.toLowerCase().indexOf(text.toLowerCase()) >= 0) {
      result.push(el)
    }
  }
  if (result.length == 0) return { list: [] };
  else return { list: result }
}
const getUnreadCount = async (groupID: string) => {
  let respData = await IMServiceManager.getInstance().getAllConversationList();
  let list;
  if (respData == undefined || respData == null || !respData) return;
  else list = JSON.parse(respData?.data);
  for (let index = 0; index < list.length; index++) {
    const element = list[index];
    if (element?.groupID == groupID) return element
  }
}
/**
 * 获取热门社区
 * @param ensDomain
 */
export const getCommunityHot = async () => {
  const resp = await CommunityRequest.post(
    "/group/get_hot_community",
    {
      operationID: `${Date.now()}`,
    },
  );
  log(resp, 'getCommunityHot')
  let newRes = [];
  for (let index = 0; index < resp?.groupInfoArray.length; index++) {
    let newDic = {};
    const element = resp?.groupInfoArray[index];
    newDic = element;
    newDic.faceURL = handleFixIpfs(element?.faceURL)
    newRes.push(newDic)
  }
  return { list: newRes }
};
/**
 * 获取热门社区
 * @param ensDomain
 */
export const getCommunityHot_NoGDataList = async () => {
  const resp = await CommunityRequest.post(
    "/group/get_hot_community",
    {
      operationID: `${Date.now()}`,
    },
  );
  log(resp, 'getCommunityHot')
  let newRes = [];
  for (let index = 0; index < resp?.groupInfoArray.length; index++) {
    let newDic = {};
    const element = resp?.groupInfoArray[index];
    newDic = element;
    newDic.faceURL = handleFixIpfs(element?.faceURL)
    newRes.push(newDic)
  }
  return newRes
};
export const getHotBanner = async () => {
  const resp = await CommunityRequest.post(
    "/group/get_hot_community",
    {
      operationID: `${Date.now()}`,
    },


  );
  const bannerArrayImage = resp.bannerArrayImage;
  const groupInfoArray = resp.groupInfoArray;
  let newData = [];
  for (let index = 0; index < bannerArrayImage.length; index++) {
    let element = groupInfoArray[index];
    element.bannerImage = handleFixIpfs(bannerArrayImage[index]?.bannerImage)
    newData.push(element)
  }
  return newData
};

//创建社区
export const createCommunityApi = async (data: CreateCommunityApiType) => {
  const res = await CommunityRequest.post(
    "/group/create_community",
    {
      operationID: `${Date.now()}`,
      ex: "",
      groupID: "",
      groupType: 2,
      ...data,
    },
  );
  return res;
}
const handleFixIpfs = (img: string) => {
  const CID = require('cids')
  if (img.indexOf("ipfs://") > -1) {
    let url = img.split("//")[1];
    if (url.startsWith("Qm") && url.indexOf("/") > 0) {
      const cid = new CID(url.split("/")[0]);
      url = cid.toV1().toString();
      return `https://${url}.ipfs.nftstorage.link/${img.split("//")[1].split("/")[1]}`;
    } else if (url.startsWith("Qm")) {
      const cid = new CID(url);
      img = cid.toV1().toString();
      return `https://${img}.ipfs.nftstorage.link`;
      // return `${IPFS_URL}${img.split("//")[1]}`;
    } else {
      return `https://${img}.ipfs.nftstorage.link`;
    }
  }
  return img;
}
//社区频道列表
export const getCommunityChannelListApi = async (groupID: string) => {
  const res = await CommunityRequest.post(
    "/group/get_community_channel_list",
    {
      operationID: `${Date.now()}`,
      groupID: groupID
    },
  );

  return res?.data;
}

//设置社区信息
export const modifyGroupInfoApi = async (data: ModifyCommunityParam) => {
  const res = await CommunityRequest.post(
    "/group/set_group_info",
    {
      ...data,
      operationID: `${Date.now()}`,
    },
  );
  return res;
}

//获取全部社区成员列表
export const getGroupAllMemberListApi = async (groupID: string) => {
  const res = await CommunityRequest.post(
    "/group/get_group_all_member_list",
    {
      groupID,
      operationID: `${Date.now()}`,
    },
  );
  let dataHandle: any = [];
  for (let index = 0; index < res?.data.length; index++) {
    let element = res?.data[index];
    element.faceURL = handleFixIpfs(element.faceURL || '');
    dataHandle.push(element);
  }
  return dataHandle;
}

//获取全部社区成员列表
export const getGroupAllMemberListApi_GDataList = async (data: any) => {
  const groupID = data?.params.groupID;
  const res = await CommunityRequest.post(
    "/group/get_group_all_member_list",
    {
      groupID,
      operationID: `${Date.now()}`,
    },
  );
  const memberData = res?.data;
  const id_list = [];
  let dataHandle: any = [];
  const creator = [];
  const member = [];

  for (let index = 0; index < memberData.length; index++) {
    let element = memberData[index];
    const userProfile = await UserService.getUserProfile(
      element.userID
    );
    element.userProfile = userProfile == '' ? t('my.noneProduce') : userProfile;
    element.faceURL = handleFixIpfs(element.faceURL || '');
    dataHandle.push(element);
    id_list.push(element?.userID)
  }
  const dataHasStatus = await UserService.getOnline(id_list);

  for (let index = 0; index < dataHasStatus.length; index++) {
    const element = dataHasStatus[index];
    for (let index2 = 0; index2 < dataHandle.length; index2++) {
      const element2 = dataHandle[index2];
      if (element.userID == element2.userID) {
        element2.isIn = (element.status == "online") ? true : false
        if (element2.roleLevel == 2) creator.push(element2)
        else member.push(element2)
      }
    }
  }
  let finalList = ['创建者（1）'];
  finalList = finalList.concat(creator);
  finalList = finalList.concat('' + member.length);
  finalList = finalList.concat(member)
  log(finalList, 'finalListfinalList')
  return { list: finalList };
}
//解散社区
export const dismissGroupApi = async (groupID: string) => {
  // return
  const res1 = await CommunityRequest.post(
    "/group/dismiss_group",
    {
      groupID: groupID,
      operationID: `${Date.now()}`,
    },
  );
  const res2 = await IMService.getConvasationID(groupID)

  try {
    IMService.deleteConversation(res1?.conversationID)
  }
  catch (e) { }
  return res1;
}

//加入社区
export const joinGroup = async (data: JoinGroupParams) => {
  const res = await IMService.joinGroup(data)

  return res;
}
//退出社区
export const quitGroup = async (groupID: string) => {
  const res = await IMService.quitGroup(groupID)
  return res;
}
//上传头像
export const uploadCommunityLogo = async (fileData: any, progressCallBack: Function, callBack: Function) => {
  return IDBITRequest.uploadFile(Constants.PINATA_APIKEY, fileData, (e: any) => {
    progressCallBack(e)
  }, (e: any) => {
    callBack(e)
  })
}

//查找社区
export const searchCommunityApi = async (data: any) => {
  const { searchTitle } = data.params
  log(searchTitle, 'searchTitle')
  const resp = await CommunityRequest.post(
    "/group/search_community",
    {
      searchTitle,
      operationID: `${Date.now()}`,
    },
  );
  const oldRes = resp?.groupInfoArray;
  let newRes = [];
  for (let index = 0; index < oldRes.length; index++) {
    let newDic = {};
    const element = oldRes[index];
    newDic = element;
    newDic.faceURL = handleFixIpfs(element.faceURL);
    newRes.push(newDic)
  }
  return { list: newRes };
}
//获取指定某个用户加入群列表
export const getUserJoinedGroupListApi = async (data: GetUserJoinedGroupListParams) => {
  const resp = await CommunityRequest.post(
    "/group/get_user_joined_group_list",
    {
      ...data,
      operationID: `${Date.now()}`,
    },
  );
  const communities = resp?.data;
  let newRes = [];
  for (let index = 0; index < communities.length; index++) {
    let newDic = {};
    const element = communities[index];
    newDic = element;
    newDic.faceURL = handleFixIpfs(element.faceURL);
    newRes.push(newDic)
  }
  return newRes;
}
//获取指定某个用户加入群列表 ,来自列表
export const getUserJoinedGroupListApi_gData = async (data: any) => {
  const { fromUserID } = data.params
  const resp = await CommunityRequest.post(
    "/group/get_user_joined_group_list",
    {
      fromUserID,
      operationID: `${Date.now()}`,
    },
  );
  const communities = resp?.data;
  let newRes = [];
  for (let index = 0; index < communities.length; index++) {
    let newDic = {};
    const element = communities[index];
    newDic = element;
    newDic.faceURL = handleFixIpfs(element.faceURL);
    newDic.unreadCount = 0;
    newDic.isJoinEd = false;
    newRes.push(newDic)
  }
  return { list: newRes };
}

//创建社区频道
export const createCommunityChannelApi = async (data: CreateCommunityChannelApiType) => {
  const resp = await CommunityRequest.post(
    "/group/create_community_channel",
    {
      ...data,
      operationID: `${Date.now()}`,
    },
  );
  return resp;
}
/**
 * 授权
 */


export const approveTx = async (wallet: any, idoAddress: string, usdtAddress: string, USDTInterface: string, amount: any) => {
  const wallet_ = new ethers.Wallet(wallet?.privateKey, gd.public_provider);
  const signer = wallet_.connect(gd.public_provider);
  const USDTContract = new ethers.Contract(usdtAddress, USDTInterface, signer);
  try {
    const result = await USDTContract.approve(idoAddress, amount);
    // Alert.alert(JSON.stringify(result))
    return {code:1}
  }
  catch (e: any) {
    log('error:' + JSON.stringify(e));
    return {code:0,msg:JSON.stringify(e)}
  }
}
/**
 * 创建IDO
 */


export const createIdo = async (args: any, wallet: any, projectText: any, tokenInfo2: any) => {
  // 创建 IDO 合约实例
  const bytecode =
    "608060405260326001553480156200001657600080fd5b50604051620039ef380380620039ef83398181016040528101906200003c919062000336565b6200005c62000050620001c560201b60201c565b620001cd60201b60201c565b82601060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081601160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555082600e60006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600f60006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080601281905550733432169802ba50d1a2bdbb012cfc449bc4f92c81601460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050505062000392565b600033905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620002c38262000296565b9050919050565b620002d581620002b6565b8114620002e157600080fd5b50565b600081519050620002f581620002ca565b92915050565b6000819050919050565b6200031081620002fb565b81146200031c57600080fd5b50565b600081519050620003308162000305565b92915050565b60008060006060848603121562000352576200035162000291565b5b60006200036286828701620002e4565b93505060206200037586828701620002e4565b925050604062000388868287016200031f565b9150509250925092565b61364d80620003a26000396000f3fe608060405234801561001057600080fd5b50600436106102115760003560e01c806383955a8811610125578063c4938a4d116100ad578063d783c5c51161007c578063d783c5c51461058c578063d9e14f74146105bc578063f2fde38b146105da578063f4ac9911146105f6578063fd0b30a11461061457610211565b8063c4938a4d14610514578063c96224f614610532578063d2f7265a14610550578063d41a58a01461056e57610211565b8063997e7889116100f4578063997e7889146104685780639a59984614610486578063a6750047146104a4578063a9c73e80146104d4578063b4277e37146104f057610211565b806383955a881461040857806387c983c7146104125780638da5cb5b1461042e57806394b918de1461044c57610211565b80635e7a440f116101a8578063715018a611610177578063715018a61461038857806378e9792514610392578063795b2cb6146103b05780637c336661146103cc57806381830593146103ea57610211565b80635e7a440f146103025780635f64b55b1461033257806364aeb9551461035057806369fe0e2d1461036c57610211565b80633a2e2c19116101e45780633a2e2c19146102a05780634fb2e45d146102be578063503538db146102da578063598643ce146102f857610211565b80630fc63d1014610216578063288cdfe4146102345780632b0f53ff146102525780633197cbb614610282575b600080fd5b61021e61061e565b60405161022b9190612066565b60405180910390f35b61023c610644565b6040516102499190612149565b60405180910390f35b61026c600480360381019061026791906122c5565b61069c565b6040516102799190612396565b60405180910390f35b61028a61074c565b60405161029791906123c7565b60405180910390f35b6102a8610752565b6040516102b591906123c7565b60405180910390f35b6102d860048036038101906102d39190612420565b610758565b005b6102e26107a6565b6040516102ef91906123c7565b60405180910390f35b6103006107ac565b005b61031c600480360381019061031791906122c5565b610a98565b6040516103299190612396565b60405180910390f35b61033a610b4e565b6040516103479190612066565b60405180910390f35b61036a60048036038101906103659190612479565b610b74565b005b61038660048036038101906103819190612479565b610c1c565b005b610390610c80565b005b61039a610c94565b6040516103a791906123c7565b60405180910390f35b6103ca60048036038101906103c59190612479565b610c9a565b005b6103d4610d12565b6040516103e191906124c1565b60405180910390f35b6103f2610d25565b6040516103ff91906124eb565b60405180910390f35b610410610d4b565b005b61042c60048036038101906104279190612506565b610f94565b005b610436610ff1565b60405161044391906124eb565b60405180910390f35b61046660048036038101906104619190612479565b61101a565b005b61047061147c565b60405161047d91906123c7565b60405180910390f35b61048e611482565b60405161049b91906123c7565b60405180910390f35b6104be60048036038101906104b99190612479565b611488565b6040516104cb91906123c7565b60405180910390f35b6104ee60048036038101906104e991906125a8565b6114ac565b005b6104f86114eb565b60405161050b9796959493929190612620565b60405180910390f35b61051c61152f565b604051610529919061276d565b60405180910390f35b61053a611718565b60405161054791906123c7565b60405180910390f35b61055861171e565b60405161056591906123c7565b60405180910390f35b610576611724565b60405161058391906124eb565b60405180910390f35b6105a660048036038101906105a1919061278f565b61174a565b6040516105b391906124c1565b60405180910390f35b6105c46117c3565b6040516105d191906123c7565b60405180910390f35b6105f460048036038101906105ef9190612420565b6117c9565b005b6105fe61184d565b60405161060b91906124eb565b60405180910390f35b61061c611873565b005b601060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6060601380548060200260200160405190810160405280929190818152602001828054801561069257602002820191906000526020600020905b81548152602001906001019080831161067e575b5050505050905090565b60606002826040516106ae919061281e565b908152602001604051809103902080546106c790612864565b80601f01602080910402602001604051908101604052809291908181526020018280546106f390612864565b80156107405780601f1061071557610100808354040283529160200191610740565b820191906000526020600020905b81548152906001019060200180831161072357829003601f168201915b50505050509050919050565b60055481565b60085481565b6107606119ff565b7f846efa3a6a5edc2ad935485ac9d10508f0c463a9b147f4f96cccff3e3b8bf99e816000604051610792929190612943565b60405180910390a16107a3816117c9565b50565b60075481565b6107b46119ff565b6005544210156107f9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107f0906129de565b60405180910390fd5b6000601060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b815260040161085691906124eb565b60206040518083038186803b15801561086e57600080fd5b505afa158015610882573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108a69190612a13565b90506000600154600154836108bb9190612a9e565b6108c59190612acf565b9050610916601460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1682600e60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16611a7d565b507f846efa3a6a5edc2ad935485ac9d10508f0c463a9b147f4f96cccff3e3b8bf99e601460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168260405161096a929190612bc1565b60405180910390a1601060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b81526004016109cd91906124eb565b60206040518083038186803b1580156109e557600080fd5b505afa1580156109f9573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a1d9190612a13565b9150610a53610a2a610ff1565b83600e60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16611a7d565b507f846efa3a6a5edc2ad935485ac9d10508f0c463a9b147f4f96cccff3e3b8bf99e610a7d610ff1565b83604051610a8c929190612c5c565b60405180910390a15050565b6002818051602081018201805184825260208301602085012081835280955050505050506000915090508054610acd90612864565b80601f0160208091040260200160405190810160405280929190818152602001828054610af990612864565b8015610b465780601f10610b1b57610100808354040283529160200191610b46565b820191906000526020600020905b815481529060010190602001808311610b2957829003601f168201915b505050505081565b601160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b610b7c6119ff565b4260045411610bc0576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bb790612cf7565b60405180910390fd5b60008167ffffffffffffffff811115610bdc57610bdb61219a565b5b604051908082528060200260200182016040528015610c1557816020015b610c02611f2a565b815260200190600190039081610bfa5790505b5090505050565b601460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163273ffffffffffffffffffffffffffffffffffffffff1614610c7657600080fd5b8060018190555050565b610c886119ff565b610c926000611aba565b565b60045481565b610ca26119ff565b4260045411610ce6576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cdd90612cf7565b60405180910390fd5b601381908060018154018082558091505060019003906000526020600020016000909190919091505550565b600c60009054906101000a900460ff1681565b601460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600554421015610d90576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d87906129de565b60405180910390fd5b6000600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205411610e12576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e0990612d63565b60405180910390fd5b60005b601380549050811015610f91576000600d600060138481548110610e3c57610e3b612d83565b5b906000526020600020015481526020019081526020016000209050600060138381548110610e6d57610e6c612d83565b5b9060005260206000200154421115610ec4578160000160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490505b6000811115610f7c57610efa3382600f60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16611a7d565b5060008260000160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055507f846efa3a6a5edc2ad935485ac9d10508f0c463a9b147f4f96cccff3e3b8bf99e3382604051610f73929190612dfe565b60405180910390a15b50508080610f8990612e4d565b915050610e15565b50565b610f9c6119ff565b8660048190555085600581905550846006819055508360078190555082600a819055508160098190555080600b819055506000600c60006101000a81548160ff02191690831515021790555050505050505050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6064811161105d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161105490612ee2565b60405180910390fd5b60095481106110a1576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161109890612f4e565b60405180910390fd5b6000601254600a54836110b49190612acf565b6110be9190612acf565b90506000816006546110d09190612f6e565b1015611111576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161110890612fee565b60405180910390fd5b6000601060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166370a08231336040518263ffffffff1660e01b815260040161116e91906124eb565b60206040518083038186803b15801561118657600080fd5b505afa15801561119a573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906111be9190612a13565b90506000601254846111d09190612acf565b905080821015611215576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161120c9061305a565b60405180910390fd5b611264333083601060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16611b7e909392919063ffffffff16565b826006546112729190612f6e565b60088190555080600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546112c7919061307a565b9250508190555080600760008282546112e0919061307a565b92505081905550600b54836112f59190612a9e565b925060005b60138054905081101561143c576000600d60006013848154811061132157611320612d83565b5b9060005260206000200154815260200190815260200160002090506000600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205411156113e157848160000160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546113d5919061307a565b92505081905550611428565b848160000160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055505b50808061143490612e4d565b9150506112fa565b507f846efa3a6a5edc2ad935485ac9d10508f0c463a9b147f4f96cccff3e3b8bf99e338560405161146e92919061311c565b60405180910390a150505050565b600b5481565b60095481565b6013818154811061149857600080fd5b906000526020600020016000915090505481565b6114b46119ff565b806002836040516114c5919061281e565b908152602001604051809103902090805190602001906114e6929190611f44565b505050565b6000806000806000806000600454600554600654600754600a54600b54600c60009054906101000a900460ff16965096509650965096509650965090919293949596565b60606000600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054116115b3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016115aa90612d63565b60405180910390fd5b600060138054905067ffffffffffffffff8111156115d4576115d361219a565b5b60405190808252806020026020018201604052801561160d57816020015b6115fa611f2a565b8152602001906001900390816115f25790505b50905060005b601380549050811015611710576000600d60006013848154811061163a57611639612d83565b5b9060005260206000200154815260200190815260200160002090506013828154811061166957611668612d83565b5b906000526020600020015483838151811061168757611686612d83565b5b602002602001015160000181815250508060000160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020548383815181106116ec576116eb612d83565b5b6020026020010151602001818152505050808061170890612e4d565b915050611613565b508091505090565b60015481565b600a5481565b600e60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000601460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163273ffffffffffffffffffffffffffffffffffffffff16146117a657600080fd5b60008490506117b781308686611b7e565b60019150509392505050565b60065481565b6117d16119ff565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415611841576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611838906131dd565b60405180910390fd5b61184a81611aba565b50565b600f60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b61187b6119ff565b6000601160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166370a08231336040518263ffffffff1660e01b81526004016118d891906124eb565b60206040518083038186803b1580156118f057600080fd5b505afa158015611904573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906119289190612a13565b905060065481101561196f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161196690613249565b60405180910390fd5b61199f601160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff163330600654611b7e565b6001600c60006101000a81548160ff0219169083151502179055507f846efa3a6a5edc2ad935485ac9d10508f0c463a9b147f4f96cccff3e3b8bf99e6119e3610ff1565b6006546040516119f49291906132b5565b60405180910390a150565b611a07611c07565b73ffffffffffffffffffffffffffffffffffffffff16611a25610ff1565b73ffffffffffffffffffffffffffffffffffffffff1614611a7b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611a7290613350565b60405180910390fd5b565b600080829050611aae85858373ffffffffffffffffffffffffffffffffffffffff16611c0f9092919063ffffffff16565b60019150509392505050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b611c01846323b872dd60e01b858585604051602401611b9f93929190613370565b604051602081830303815290604052907bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050611c95565b50505050565b600033905090565b611c908363a9059cbb60e01b8484604051602401611c2e9291906133a7565b604051602081830303815290604052907bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050611c95565b505050565b6000611cf7826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c65648152508573ffffffffffffffffffffffffffffffffffffffff16611d5c9092919063ffffffff16565b9050600081511115611d575780806020019051810190611d1791906133fc565b611d56576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611d4d9061349b565b60405180910390fd5b5b505050565b6060611d6b8484600085611d74565b90509392505050565b606082471015611db9576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611db09061352d565b60405180910390fd5b6000808673ffffffffffffffffffffffffffffffffffffffff168587604051611de29190613594565b60006040518083038185875af1925050503d8060008114611e1f576040519150601f19603f3d011682016040523d82523d6000602084013e611e24565b606091505b5091509150611e3587838387611e41565b92505050949350505050565b60608315611ea457600083511415611e9c57611e5c85611eb7565b611e9b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611e92906135f7565b60405180910390fd5b5b829050611eaf565b611eae8383611eda565b5b949350505050565b6000808273ffffffffffffffffffffffffffffffffffffffff163b119050919050565b600082511115611eed5781518083602001fd5b806040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611f219190612396565b60405180910390fd5b604051806040016040528060008152602001600081525090565b828054611f5090612864565b90600052602060002090601f016020900481019282611f725760008555611fb9565b82601f10611f8b57805160ff1916838001178555611fb9565b82800160010185558215611fb9579182015b82811115611fb8578251825591602001919060010190611f9d565b5b509050611fc69190611fca565b5090565b5b80821115611fe3576000816000905550600101611fcb565b5090565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600061202c61202761202284611fe7565b612007565b611fe7565b9050919050565b600061203e82612011565b9050919050565b600061205082612033565b9050919050565b61206081612045565b82525050565b600060208201905061207b6000830184612057565b92915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6000819050919050565b6120c0816120ad565b82525050565b60006120d283836120b7565b60208301905092915050565b6000602082019050919050565b60006120f682612081565b612100818561208c565b935061210b8361209d565b8060005b8381101561213c57815161212388826120c6565b975061212e836120de565b92505060018101905061210f565b5085935050505092915050565b6000602082019050818103600083015261216381846120eb565b905092915050565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6121d282612189565b810181811067ffffffffffffffff821117156121f1576121f061219a565b5b80604052505050565b600061220461216b565b905061221082826121c9565b919050565b600067ffffffffffffffff8211156122305761222f61219a565b5b61223982612189565b9050602081019050919050565b82818337600083830152505050565b600061226861226384612215565b6121fa565b90508281526020810184848401111561228457612283612184565b5b61228f848285612246565b509392505050565b600082601f8301126122ac576122ab61217f565b5b81356122bc848260208601612255565b91505092915050565b6000602082840312156122db576122da612175565b5b600082013567ffffffffffffffff8111156122f9576122f861217a565b5b61230584828501612297565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561234857808201518184015260208101905061232d565b83811115612357576000848401525b50505050565b60006123688261230e565b6123728185612319565b935061238281856020860161232a565b61238b81612189565b840191505092915050565b600060208201905081810360008301526123b0818461235d565b905092915050565b6123c1816120ad565b82525050565b60006020820190506123dc60008301846123b8565b92915050565b60006123ed82611fe7565b9050919050565b6123fd816123e2565b811461240857600080fd5b50565b60008135905061241a816123f4565b92915050565b60006020828403121561243657612435612175565b5b60006124448482850161240b565b91505092915050565b612456816120ad565b811461246157600080fd5b50565b6000813590506124738161244d565b92915050565b60006020828403121561248f5761248e612175565b5b600061249d84828501612464565b91505092915050565b60008115159050919050565b6124bb816124a6565b82525050565b60006020820190506124d660008301846124b2565b92915050565b6124e5816123e2565b82525050565b600060208201905061250060008301846124dc565b92915050565b600080600080600080600060e0888a03121561252557612524612175565b5b60006125338a828b01612464565b97505060206125448a828b01612464565b96505060406125558a828b01612464565b95505060606125668a828b01612464565b94505060806125778a828b01612464565b93505060a06125888a828b01612464565b92505060c06125998a828b01612464565b91505092959891949750929550565b600080604083850312156125bf576125be612175565b5b600083013567ffffffffffffffff8111156125dd576125dc61217a565b5b6125e985828601612297565b925050602083013567ffffffffffffffff81111561260a5761260961217a565b5b61261685828601612297565b9150509250929050565b600060e082019050612635600083018a6123b8565b61264260208301896123b8565b61264f60408301886123b8565b61265c60608301876123b8565b61266960808301866123b8565b61267660a08301856123b8565b61268360c08301846124b2565b98975050505050505050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6040820160008201516126d160008501826120b7565b5060208201516126e460208501826120b7565b50505050565b60006126f683836126bb565b60408301905092915050565b6000602082019050919050565b600061271a8261268f565b612724818561269a565b935061272f836126ab565b8060005b8381101561276057815161274788826126ea565b975061275283612702565b925050600181019050612733565b5085935050505092915050565b60006020820190508181036000830152612787818461270f565b905092915050565b6000806000606084860312156127a8576127a7612175565b5b60006127b68682870161240b565b93505060206127c78682870161240b565b92505060406127d886828701612464565b9150509250925092565b600081905092915050565b60006127f88261230e565b61280281856127e2565b935061281281856020860161232a565b80840191505092915050565b600061282a82846127ed565b915081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061287c57607f821691505b602082108114156128905761288f612835565b5b50919050565b7f7472616e736665724f776e657200000000000000000000000000000000000000600082015250565b60006128cc600d83612319565b91506128d782612896565b602082019050919050565b50565b60006128f2600083612319565b91506128fd826128e2565b600082019050919050565b6000819050919050565b600061292d61292861292384612908565b612007565b6120ad565b9050919050565b61293d81612912565b82525050565b6000608082019050818103600083015261295c816128bf565b905061296b60208301856124dc565b818103604083015261297c816128e5565b905061298b6060830184612934565b9392505050565b7f70726f6a65637420756e66696e69736865640000000000000000000000000000600082015250565b60006129c8601283612319565b91506129d382612992565b602082019050919050565b600060208201905081810360008301526129f7816129bb565b9050919050565b600081519050612a0d8161244d565b92915050565b600060208284031215612a2957612a28612175565b5b6000612a37848285016129fe565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000612aa9826120ad565b9150612ab4836120ad565b925082612ac457612ac3612a40565b5b828204905092915050565b6000612ada826120ad565b9150612ae5836120ad565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615612b1e57612b1d612a6f565b5b828202905092915050565b7f726563656976654f776e65720000000000000000000000000000000000000000600082015250565b6000612b5f600c83612319565b9150612b6a82612b29565b602082019050919050565b7f6665650000000000000000000000000000000000000000000000000000000000600082015250565b6000612bab600383612319565b9150612bb682612b75565b602082019050919050565b60006080820190508181036000830152612bda81612b52565b9050612be960208301856124dc565b8181036040830152612bfa81612b9e565b9050612c0960608301846123b8565b9392505050565b7f616d6f756e740000000000000000000000000000000000000000000000000000600082015250565b6000612c46600683612319565b9150612c5182612c10565b602082019050919050565b60006080820190508181036000830152612c7581612b52565b9050612c8460208301856124dc565b8181036040830152612c9581612c39565b9050612ca460608301846123b8565b9392505050565b7f726169736520616c726561647920737461727421000000000000000000000000600082015250565b6000612ce1601483612319565b9150612cec82612cab565b602082019050919050565b60006020820190508181036000830152612d1081612cd4565b9050919050565b7f796f7520617265204e6f7420696e766f6c766564000000000000000000000000600082015250565b6000612d4d601483612319565b9150612d5882612d17565b602082019050919050565b60006020820190508181036000830152612d7c81612d40565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f7265636569766555736572000000000000000000000000000000000000000000600082015250565b6000612de8600b83612319565b9150612df382612db2565b602082019050919050565b60006080820190508181036000830152612e1781612ddb565b9050612e2660208301856124dc565b8181036040830152612e37816128e5565b9050612e4660608301846123b8565b9392505050565b6000612e58826120ad565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415612e8b57612e8a612a6f565b5b600182019050919050565b7f616d6f756e7420657863656564206d696e000000000000000000000000000000600082015250565b6000612ecc601183612319565b9150612ed782612e96565b602082019050919050565b60006020820190508181036000830152612efb81612ebf565b9050919050565b7f616d6f756e7420657863656564206d6178000000000000000000000000000000600082015250565b6000612f38601183612319565b9150612f4382612f02565b602082019050919050565b60006020820190508181036000830152612f6781612f2b565b9050919050565b6000612f79826120ad565b9150612f84836120ad565b925082821015612f9757612f96612a6f565b5b828203905092915050565b7f737572706c757320616d6f756e7420696e73756666696369656e740000000000600082015250565b6000612fd8601b83612319565b9150612fe382612fa2565b602082019050919050565b6000602082019050818103600083015261300781612fcb565b9050919050565b7f657263323020616d6f756e7420657863656564732062616c616e636500000000600082015250565b6000613044601c83612319565b915061304f8261300e565b602082019050919050565b6000602082019050818103600083015261307381613037565b9050919050565b6000613085826120ad565b9150613090836120ad565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156130c5576130c4612a6f565b5b828201905092915050565b7f7377617000000000000000000000000000000000000000000000000000000000600082015250565b6000613106600483612319565b9150613111826130d0565b602082019050919050565b60006080820190508181036000830152613135816130f9565b905061314460208301856124dc565b8181036040830152613155816128e5565b905061316460608301846123b8565b9392505050565b7f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160008201527f6464726573730000000000000000000000000000000000000000000000000000602082015250565b60006131c7602683612319565b91506131d28261316b565b604082019050919050565b600060208201905081810360008301526131f6816131ba565b9050919050565b7f496e73756666696369656e742062616c616e6365000000000000000000000000600082015250565b6000613233601483612319565b915061323e826131fd565b602082019050919050565b6000602082019050818103600083015261326281613226565b9050919050565b7f726566696c6c4f776e6572000000000000000000000000000000000000000000600082015250565b600061329f600b83612319565b91506132aa82613269565b602082019050919050565b600060808201905081810360008301526132ce81613292565b90506132dd60208301856124dc565b81810360408301526132ee81612c39565b90506132fd60608301846123b8565b9392505050565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572600082015250565b600061333a602083612319565b915061334582613304565b602082019050919050565b600060208201905081810360008301526133698161332d565b9050919050565b600060608201905061338560008301866124dc565b61339260208301856124dc565b61339f60408301846123b8565b949350505050565b60006040820190506133bc60008301856124dc565b6133c960208301846123b8565b9392505050565b6133d9816124a6565b81146133e457600080fd5b50565b6000815190506133f6816133d0565b92915050565b60006020828403121561341257613411612175565b5b6000613420848285016133e7565b91505092915050565b7f5361666545524332303a204552433230206f7065726174696f6e20646964206e60008201527f6f74207375636365656400000000000000000000000000000000000000000000602082015250565b6000613485602a83612319565b915061349082613429565b604082019050919050565b600060208201905081810360008301526134b481613478565b9050919050565b7f416464726573733a20696e73756666696369656e742062616c616e636520666f60008201527f722063616c6c0000000000000000000000000000000000000000000000000000602082015250565b6000613517602683612319565b9150613522826134bb565b604082019050919050565b600060208201905081810360008301526135468161350a565b9050919050565b600081519050919050565b600081905092915050565b600061356e8261354d565b6135788185613558565b935061358881856020860161232a565b80840191505092915050565b60006135a08284613563565b915081905092915050565b7f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000600082015250565b60006135e1601d83612319565b91506135ec826135ab565b602082019050919050565b60006020820190508181036000830152613610816135d4565b905091905056fea2646970667358221220fecd4ebb299d0498eae1557887124ee81e704231ec18f0ef42ee41f3e91e395064736f6c63430008090033000000000000000000000000636e7652db6a961e47459586ecf256358a6f15f90000000000000000000000001d3a434eeac22d9935c14557d04b6b2d466696f700000000000000000000000000000000000000000000000000038d7ea4c68000";

  pinJsonToIPFS(projectText, async (responseData: any) => {
    console.log('Fetch Success==================');
    const c = responseData?.IpfsHash;
    Alert.alert(JSON.stringify(c))
    args.projectText = c;
    const wallet_ = new ethers.Wallet(wallet?.privateKey, gd.public_provider);
    // const factory = new ethers.ContractFactory(IdoAbi, bytecode, wallet_)
    // const contract = await factory.deploy('0x9B3802d47663083abd60249A7a2a0DB31b7Aec10')
    // await contract.deployed()
    const signer = wallet_.connect(gd.public_provider);
    const contract = new ethers.Contract('0xbdac78ad89149343a8c0f38ae768c0a90d09ebd1', IdoAbi, signer);
    const gasPrice =await gd.public_provider.getGasPrice()
    let overrides = {
        gasLimit: 1230000,
        gasPrice: gasPrice,
        nonce: (await gd.public_provider.getTransactionCount(wallet.address)),
      }
    console.log('datadatadatadata' + JSON.stringify(args));
    const tx = await contract.createIDO({...args},overrides);
      await tx.wait();
      return

    // 等待交易上链
    await tx.wait();
  }, (e: any) => {
    toast(t('common.error' + ':' + JSON.stringify(e)))
  });
  return
  // 初始化一个以太坊 wallet
  const signer = wallet_.connect(gd.public_provider);
  // 获取合约工厂
  const contractFactory = new ethers.ContractFactory(IdoAbi, bytecode, wallet_);

  pinJsonToIPFS(projectText, async (responseData: any) => {
    console.log('Fetch Success==================');
    console.log(responseData);
    const c = 'ipfs://' + responseData?.IpfsHash;
    data.projectText = c;
    // 与部署的智能合约进行交互
    const contract = new ethers.Contract('0x9B3802d47663083abd60249A7a2a0DB31b7Aec10', IdoAbi, signer);
    // const contract2 = new ethers.Contract('0x9B3802d47663083abd60249A7a2a0DB31b7Aec10', IdoAbi, gd.public_provider);

    // const gas=await contract.estimateGas.createIDO({...data});
    // Alert.alert(JSON.stringify(data))
    // return
    // const tx = await contract.createIDO({...data});
    // // 估算gas费
    // const gasLimit = await gd.public_provider.estimateGas(tx);
    // console.log(`Gas limit: ${gasLimit.toString()}`);

    // // 获取当前gas价格
    // const gasPrice = await gd.public_provider.getGasPrice();
    // console.log(`Gas price: ${gasPrice.toString()}`);

    // // 计算总费用
    // const fee = gasLimit.mul(gasPrice);
    // console.log(`Total fee: ${ethers.utils.formatEther(fee)} ETH`);
    // 调用 .deploy() 方法部署合约

    const contractInstance = await contractFactory.deploy([data]
    );

    Alert.alert(JSON.stringify('fee'))
    return
    await contractInstance.deployed();

    // 等待智能合约部署完成
    await contractInstance.deployTransaction.wait();

    // 与部署的智能合约进行交互
    const signer2 = gd.public_provider.getSigner();
    const contract2 = new ethers.Contract(contractInstance.address, IdoAbi, signer);
    const result = await contract.someMethod();
    console.log("Result:", result);

    return contractInstance;
  }, (e: any) => {
    toast(t('common.error' + ':' + JSON.stringify(e)))
  });
}

